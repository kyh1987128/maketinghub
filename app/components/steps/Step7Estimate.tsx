
'use client';

import { useState, useEffect, useCallback } from 'react';

interface Props {
  data: any;
  onUpdate: (data: any) => void;
  onNext: () => void;
  onPrev: () => void;
}

export default function Step7Estimate({ data, onUpdate, onNext, onPrev }: Props) {
  const [estimateData, setEstimateData] = useState(data.estimate || {});
  const [timelineData, setTimelineData] = useState(data.timeline || {});
  const [additionalNotes, setAdditionalNotes] = useState(data.step7Notes || '');
  const [activeTab, setActiveTab] = useState<'estimate' | 'timeline' | 'analysis'>('estimate');

  const serviceType = data.serviceType || 'video';

  // üöÄ Ïã§Ï†ú 5Îã®Í≥Ñ Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú Ìïú ÎèôÏ†Å Í≤¨Ï†Å Í≥ÑÏÇ∞
  const calculateDetailedEstimate = useCallback(() => {
    // üöÄ FIXED: 5Îã®Í≥ÑÏóêÏÑú Ï†ÑÎã¨Îêú Ïã§Ï†ú Í≥ÑÏÇ∞Í∞í Ïö∞ÏÑ† ÏÇ¨Ïö©
    const step5RealPrice = data.realTimePrice || data.calculatedTotalCost || data.calculatedImpact || 0;
    const step5RealDays = data.realTimeDays || data.calculatedTimeAdd || 3;
    
    console.log('üöÄ 7Îã®Í≥Ñ Í≤¨Ï†Å Í≥ÑÏÇ∞ - 5Îã®Í≥Ñ Îç∞Ïù¥ÌÑ∞:', {
      realTimePrice: data.realTimePrice,
      calculatedTotalCost: data.calculatedTotalCost,
      calculatedImpact: data.calculatedImpact,
      step5Elements: Object.keys(data.elements || {}).filter(k => data.elements?.[k]?.enabled).length,
      finalPrice: step5RealPrice,
      finalDays: step5RealDays
    });

    let low, mid, high;
    let totalDays;
    
    if (step5RealPrice > 0) {
      // üöÄ 5Îã®Í≥ÑÏóêÏÑú Ïã§Ï†ú ÏÑ†ÌÉùÎêú ÏòµÏÖò Í∞ÄÍ≤©ÏùÑ Í∏∞Ï§ÄÏúºÎ°ú Í≤¨Ï†Å ÏÇ∞Ï∂ú
      low = Math.floor(step5RealPrice * 0.85);  // 15% Ìï†Ïù∏
      mid = step5RealPrice;  // Ïã§Ï†ú ÏÑ†ÌÉù Í∞ÄÍ≤©
      high = Math.floor(step5RealPrice * 1.25); // 25% Ï∂îÍ∞Ä
      totalDays = Math.max(step5RealDays, 3);
      
      console.log('‚úÖ 5Îã®Í≥Ñ Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Í≤¨Ï†Å Ï†ÅÏö©:', { low, mid, high, totalDays });
    } else {
      // Í∏∞Î≥∏ ÏÑúÎπÑÏä§Î≥Ñ ÏµúÏÜå Í≤¨Ï†Å (5Îã®Í≥Ñ ÏÑ†ÌÉùÏù¥ ÏóÜÏùÑ Í≤ΩÏö∞ÏóêÎßå)
      const defaultEstimates = {
        video: { low: 1000000, mid: 1800000, high: 3000000, days: 7 },
        design: { low: 800000, mid: 1500000, high: 2500000, days: 10 },
        marketing: { low: 1500000, mid: 3000000, high: 5000000, days: 14 }
      };
      
      const defaultEst = defaultEstimates[serviceType] || defaultEstimates.video;
      low = defaultEst.low;
      mid = defaultEst.mid;
      high = defaultEst.high;
      totalDays = defaultEst.days;
      
      console.log('‚ö†Ô∏è Í∏∞Î≥∏ Í≤¨Ï†Å Ï†ÅÏö© (5Îã®Í≥Ñ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå):', { low, mid, high, totalDays });
    }

    // üöÄ ÏÑúÎπÑÏä§Î≥Ñ Í≤¨Ï†Å ÏÑ∏Î∂Ä Ìï≠Î™©
    const getBreakdownByService = () => {
      switch (serviceType) {
        case 'video':
          return [
            { name: 'Í∏∞Ìöç Î∞è ÏãúÎÇòÎ¶¨Ïò§', impact: Math.floor(mid * 0.15) },
            { name: 'Ï¥¨ÏòÅ Î∞è ÌòÑÏû• ÏûëÏóÖ', impact: Math.floor(mid * 0.35) },
            { name: 'Ìé∏Ïßë Î∞è ÌõÑÏûëÏóÖ', impact: Math.floor(mid * 0.25) },
            { name: 'ÏùåÌñ• Î∞è ÏùåÏïÖ', impact: Math.floor(mid * 0.10) },
            { name: 'Í∑∏ÎûòÌîΩ Î∞è ÌäπÏàòÌö®Í≥º', impact: Math.floor(mid * 0.10) },
            { name: 'ÏµúÏ¢Ö ÎßàÏä§ÌÑ∞ÎßÅ', impact: Math.floor(mid * 0.05) }
          ];
        case 'design':
          return [
            { name: 'Ïª®ÏÖâ Í∏∞Ìöç Î∞è Î¶¨ÏÑúÏπò', impact: Math.floor(mid * 0.20) },
            { name: 'ÎîîÏûêÏù∏ ÏãúÏïà ÏûëÏóÖ', impact: Math.floor(mid * 0.40) },
            { name: 'ÌîºÎìúÎ∞± Î∞òÏòÅ Î∞è ÏàòÏ†ï', impact: Math.floor(mid * 0.20) },
            { name: 'ÏµúÏ¢Ö ÌååÏùº Ï†úÏûë', impact: Math.floor(mid * 0.15) },
            { name: 'Í∞ÄÏù¥ÎìúÎùºÏù∏ ÏûëÏÑ±', impact: Math.floor(mid * 0.05) }
          ];
        case 'marketing':
          return [
            { name: 'ÏãúÏû• Î∂ÑÏÑù Î∞è Ï†ÑÎûµ ÏàòÎ¶Ω', impact: Math.floor(mid * 0.25) },
            { name: 'Ï∫†ÌéòÏù∏ Í∏∞Ìöç Î∞è ÏÑ§Í≥Ñ', impact: Math.floor(mid * 0.20) },
            { name: 'ÏΩòÌÖêÏ∏† Ï†úÏûë Î∞è Í¥ÄÎ¶¨', impact: Math.floor(mid * 0.30) },
            { name: 'Í¥ëÍ≥† Ïö¥ÏòÅ Î∞è ÏµúÏ†ÅÌôî', impact: Math.floor(mid * 0.15) },
            { name: 'ÏÑ±Í≥º Î∂ÑÏÑù Î∞è Î¶¨Ìè¨ÌåÖ', impact: Math.floor(mid * 0.10) }
          ];
        default:
          return [{ name: 'Í∏∞Î≥∏ Ï†úÏûëÎπÑ', impact: mid }];
      }
    };

    // üöÄ ÏÑúÎπÑÏä§Î≥Ñ ÏùºÏ†ï Îã®Í≥Ñ
    const getPhasesByService = () => {
      switch (serviceType) {
        case 'video':
          return [
            { name: 'Í∏∞Ìöç Î∞è ÏÇ¨Ï†Ñ Ï†úÏûë', days: Math.ceil(totalDays * 0.25) },
            { name: 'Ï¥¨ÏòÅ Î∞è ÌòÑÏû• ÏûëÏóÖ', days: Math.ceil(totalDays * 0.35) },
            { name: 'Ìé∏Ïßë Î∞è ÌõÑÏûëÏóÖ', days: Math.ceil(totalDays * 0.30) },
            { name: 'ÏµúÏ¢Ö Í≤ÄÌÜ† Î∞è ÏàòÏ†ï', days: Math.ceil(totalDays * 0.10) }
          ];
        case 'design':
          return [
            { name: 'Î¶¨ÏÑúÏπò Î∞è Ïª®ÏÖâ Í∏∞Ìöç', days: Math.ceil(totalDays * 0.20) },
            { name: 'Ï¥àÏïà ÎîîÏûêÏù∏ ÏûëÏóÖ', days: Math.ceil(totalDays * 0.40) },
            { name: 'ÌîºÎìúÎ∞± Î∞è ÏàòÏ†ï ÏûëÏóÖ', days: Math.ceil(totalDays * 0.30) },
            { name: 'ÏµúÏ¢Ö ÏôÑÏÑ± Î∞è Ï†ÑÎã¨', days: Math.ceil(totalDays * 0.10) }
          ];
        case 'marketing':
          return [
            { name: 'Ï†ÑÎûµ ÏàòÎ¶Ω Î∞è Í∏∞Ìöç', days: Math.ceil(totalDays * 0.25) },
            { name: 'ÏΩòÌÖêÏ∏† Ï†úÏûë Î∞è Ï§ÄÎπÑ', days: Math.ceil(totalDays * 0.35) },
            { name: 'Ï∫†ÌéòÏù∏ Ïã§Ìñâ Î∞è Ïö¥ÏòÅ', days: Math.ceil(totalDays * 0.30) },
            { name: 'ÏÑ±Í≥º Î∂ÑÏÑù Î∞è ÏµúÏ†ÅÌôî', days: Math.ceil(totalDays * 0.10) }
          ];
        default:
          return [{ name: 'Ï†úÏûë ÏûëÏóÖ', days: totalDays }];
      }
    };

    const estimate = {
      low,
      mid,
      high,
      breakdown: getBreakdownByService()
    };

    const timeline = {
      total: totalDays,
      phases: getPhasesByService()
    };

    setEstimateData(estimate);
    setTimelineData(timeline);

    onUpdate({
      estimate,
      timeline,
      step7Notes: additionalNotes
    });
  }, [data, serviceType, additionalNotes, onUpdate]);

  // üöÄ ÏÑúÎπÑÏä§Î≥Ñ ÎßûÏ∂§ AI Î∂ÑÏÑù
  const getIndustryAnalysis = () => {
    switch (serviceType) {
      case 'video':
        return {
          marketTrends: [
            'ÏàèÌèº ÏΩòÌÖêÏ∏† ÏàòÏöî Í∏âÏ¶ù (73% Ï¶ùÍ∞Ä)',
            'Î™®Î∞îÏùº ÏµúÏ†ÅÌôî ÏòÅÏÉÅ ÌïÑÏàò',
            'Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÏòÅÏÉÅ ÏΩòÌÖêÏ∏† Ìä∏Î†åÎìú',
            'ÎùºÏù¥Î∏å Ïä§Ìä∏Î¶¨Î∞ç ÌÜµÌï© ÏÑúÎπÑÏä§'
          ],
          budgetGuidelines: [
            'Í∏∞Î≥∏ ÌîÑÎ°úÎ™®ÏÖò ÏòÅÏÉÅ: 100-300ÎßåÏõê',
            'Í∏∞ÏóÖ ÌôçÎ≥¥ ÏòÅÏÉÅ: 300-800ÎßåÏõê',
            'Ï†ÑÎ¨∏ Îã§ÌÅêÎ©òÌÑ∞Î¶¨: 800-2000ÎßåÏõê',
            'ÎåÄÍ∑úÎ™® Ï∫†ÌéòÏù∏ ÏòÅÏÉÅ: 2000ÎßåÏõê+'
          ],
          recommendations: [
            'ÌÉÄÍ≤ü Ïó∞Î†πÎåÄÏóê ÎßûÎäî ÏòÅÏÉÅ Í∏∏Ïù¥ ÏµúÏ†ÅÌôî',
            'Î©ÄÌã∞ÌîåÎû´Ìèº ÌôúÏö©ÏùÑ ÏúÑÌïú Îã§ÏñëÌïú Ìè¨Îß∑ Ï†úÏûë',
            'A/B ÌÖåÏä§Ìä∏Î•º ÌÜµÌïú ÏΩòÌÖêÏ∏† ÏµúÏ†ÅÌôî',
            'Î∏åÎûúÎìú ÏùºÍ¥ÄÏÑ±ÏùÑ ÏúÑÌïú ÌÜ§Ïï§Îß§ÎÑà ÌÜµÏùº'
          ]
        };
      case 'design':
        return {
          marketTrends: [
            'ÎØ∏ÎãàÎ©ÄÎ¶¨Ï¶òÍ≥º Í∏∞Îä•ÏÑ± Ï§ëÏã¨ ÎîîÏûêÏù∏',
            'Ï†ëÍ∑ºÏÑ±Í≥º Ìè¨Ïö©ÏÑ±ÏùÑ Í≥†Î†§Ìïú ÎîîÏûêÏù∏',
            'Î∏åÎûúÎìú ÏïÑÏù¥Îç¥Ìã∞Ìã∞ ÏùºÍ¥ÄÏÑ± Í∞ïÌôî',
            'ÏßÄÏÜçÍ∞ÄÎä•ÏÑ±ÏùÑ Î∞òÏòÅÌïú ÎîîÏûêÏù∏'
          ],
          budgetGuidelines: [
            'Î°úÍ≥† ÎîîÏûêÏù∏: 50-200ÎßåÏõê',
            'Î∏åÎûúÎìú Ìå®ÌÇ§ÏßÄ: 200-500ÎßåÏõê',
            'ÏõπÏÇ¨Ïù¥Ìä∏ ÎîîÏûêÏù∏: 300-1000ÎßåÏõê',
            'Ï¢ÖÌï© Î∏åÎûúÎî©: 1000ÎßåÏõê+'
          ],
          recommendations: [
            'ÌÉÄÍ≤ü Í≥†Í∞ùÏùò Î¨∏ÌôîÏ†Å Î∞∞Í≤Ω Í≥†Î†§',
            'Îã§ÏñëÌïú Îß§Ï≤¥ÏóêÏÑúÏùò ÌôïÏû•ÏÑ± Í≤ÄÌÜ†',
            'Í≤ΩÏüÅÏÇ¨ ÎåÄÎπÑ Ï∞®Î≥ÑÌôî Ìè¨Ïù∏Ìä∏ Í∞ïÌôî',
            'Ìä∏Î†åÎìúÏôÄ Î∏åÎûúÎìú Í≥†Ïú†ÏÑ±Ïùò Í∑†Ìòï'
          ]
        };
      case 'marketing':
        return {
          marketTrends: [
            'Í∞úÏù∏ÌôîÎêú ÎßàÏºÄÌåÖ Î©îÏãúÏßÄ Ï§ëÏöîÏÑ± Ï¶ùÍ∞Ä',
            'Ïò¥ÎãàÏ±ÑÎÑê ÎßàÏºÄÌåÖ Ï†ÑÎûµ ÌïÑÏàò',
            'Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò ÏùòÏÇ¨Í≤∞Ï†ï ÌôïÏÇ∞',
            'Ïù∏ÌîåÎ£®Ïñ∏ÏÑúÏôÄÏùò ÌòëÏóÖ ÌôïÎåÄ'
          ],
          budgetGuidelines: [
            'ÏÜåÍ∑úÎ™® ÎîîÏßÄÌÑ∏ Ï∫†ÌéòÏù∏: Ïõî 100-300ÎßåÏõê',
            'Ï¢ÖÌï© ÎßàÏºÄÌåÖ Ìå®ÌÇ§ÏßÄ: Ïõî 300-800ÎßåÏõê',
            'ÎåÄÍ∑úÎ™® Î∏åÎûúÎìú Ï∫†ÌéòÏù∏: Ïõî 800ÎßåÏõê+',
            'Ïó∞Í∞Ñ ÎßàÏºÄÌåÖ Ï†ÑÎûµ: 5000ÎßåÏõê+'
          ],
          recommendations: [
            'Î™ÖÌôïÌïú KPI ÏÑ§Ï†ïÍ≥º ÏßÄÏÜçÏ†Å Î™®ÎãàÌÑ∞ÎßÅ',
            'ÌîåÎû´ÌèºÎ≥Ñ ÏΩòÌÖêÏ∏† ÏµúÏ†ÅÌôî',
            'Í≥†Í∞ù Ïó¨Ï†ïÏóê Îî∞Î•∏ ÎßûÏ∂§ Î©îÏãúÏßÄ',
            'Î∏åÎûúÎìú Ïä§ÌÜ†Î¶¨ÏôÄ Í∞ÄÏπò ÏùºÍ¥ÄÏÑ± Ïú†ÏßÄ'
          ]
        };
      default:
        return {
          marketTrends: ['ÏãúÏû• Î∂ÑÏÑù Ï†ïÎ≥¥ ÏóÜÏùå'],
          budgetGuidelines: ['ÏòàÏÇ∞ Í∞ÄÏù¥ÎìúÎùºÏù∏ ÏóÜÏùå'],
          recommendations: ['Ï∂îÏ≤úÏÇ¨Ìï≠ ÏóÜÏùå']
        };
    }
  };

  const industryAnalysis = getIndustryAnalysis();

  // üöÄ Ï≤òÏùåÏúºÎ°ú Í∞ÄÍ∏∞ Ìï®Ïàò
  const handleGoToFirst = () => {
    if (window.confirm('Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå? ÏûÖÎ†•ÌïòÏã† Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.')) {
      window.location.reload();
    }
  };

  // üöÄ ÏôÑÏ†ÑÌïú Í≤¨Ï†ÅÏÑú Ïù∏ÏáÑ Ìï®Ïàò
  const handlePrintSummary = () => {
    const printContent = `
      <!DOCTYPE html>
      <html>
        <head>
          <title>Ï†úÏûë ÏùòÎ¢∞ Í≤¨Ï†ÅÏÑú</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
            .section { margin-bottom: 30px; page-break-inside: avoid; }
            .section h2 { color: #333; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .info-box { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
            .price-highlight { font-size: 24px; font-weight: bold; color: #2563eb; text-align: center; padding: 20px; background: #f0f9ff; border-radius: 10px; }
            .timeline-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
            .breakdown-item { display: flex; justify-content: space-between; padding: 8px 0; }
            ul { padding-left: 20px; }
            li { margin-bottom: 5px; }
            @media print { body { margin: 0; } .no-print { display: none; } }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Ï†úÏûë ÏùòÎ¢∞ Í≤¨Ï†ÅÏÑú</h1>
            <p>Î∞úÌñâÏùº: ${new Date().toLocaleDateString('ko-KR')}</p>
          </div>
          
          <div class="section">
            <h2>üìã ÌîÑÎ°úÏ†ùÌä∏ Í∞úÏöî</h2>
            <div class="info-grid">
              <div class="info-box">
                <h3>ÏÑúÎπÑÏä§ Î∂ÑÏïº</h3>
                <p>${data.serviceType === 'video' ? 'ÏòÅÏÉÅ Ï†úÏûë' : data.serviceType === 'design' ? 'ÎîîÏûêÏù∏ Ï†úÏûë' : 'ÎßàÏºÄÌåÖ ÏÑúÎπÑÏä§'}</p>
              </div>
              <div class="info-box">
                <h3>ÏÑ†ÌÉùÎêú Î™©Ï†Å</h3>
                <p>${(data.purposes || []).join(', ')}</p>
              </div>
            </div>
            <div class="info-box">
              <h3>ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Î™Ö</h3>
              <p>${data.userInput || 'Ï∂îÍ∞Ä ÏÑ§Î™Ö ÏóÜÏùå'}</p>
            </div>
          </div>

          <div class="section">
            <h2>üéØ ÌÉÄÍ≤ü ÎåÄÏÉÅ</h2>
            <div class="info-grid">
              <div class="info-box">
                <h3>Ïó∞Î†πÎåÄ</h3>
                <p>${(data.targetData?.ageGroups || []).join(', ') || 'ÎØ∏ÏßÄÏ†ï'}</p>
              </div>
              <div class="info-box">
                <h3>ÏÑ±Î≥Ñ</h3>
                <p>${(data.targetData?.gender || []).join(', ') || 'ÎØ∏ÏßÄÏ†ï'}</p>
              </div>
              <div class="info-box">
                <h3>ÏßÄÏó≠</h3>
                <p>${(data.targetData?.regions || []).join(', ') || 'ÎØ∏ÏßÄÏ†ï'}</p>
              </div>
              <div class="info-box">
                <h3>Í¥ÄÏã¨ÏÇ¨</h3>
                <p>${(data.targetData?.interests || []).join(', ') || 'ÎØ∏ÏßÄÏ†ï'}</p>
              </div>
            </div>
          </div>

          <div class="section">
            <h2>üìù ÏÑ∏Î∂Ä Ïö©ÎèÑ Î∞è Í∑úÎ™®</h2>
            <div class="info-grid">
              <div class="info-box">
                <h3>ÏÑ∏Î∂Ä Ïö©ÎèÑ</h3>
                <p>${(data.details || []).join(', ') || 'ÎØ∏ÏßÄÏ†ï'}</p>
              </div>
              <div class="info-box">
                <h3>ÌîÑÎ°úÏ†ùÌä∏ Í∑úÎ™®</h3>
                <p>${data.scale?.type || 'ÎØ∏ÏßÄÏ†ï'}: ${data.scale?.value || ''}</p>
              </div>
            </div>
          </div>

          <div class="section">
            <h2>‚öôÔ∏è ÏÑ†ÌÉùÎêú ÏÑ∏Î∂Ä ÏòµÏÖò</h2>
            <div class="info-box">
              ${Object.keys(data.elements || {}).filter(key => data.elements[key]?.enabled).map(key => {
                const element = data.elements[key];
                return `<div class="breakdown-item">
                  <span>${key.replace('.', ' > ')}</span>
                  <span>ÏòµÏÖò ${element.selectedOption + 1}Î≤à</span>
                </div>`;
              }).join('') || '<p>ÏÑ†ÌÉùÎêú ÏòµÏÖò ÏóÜÏùå</p>'}
            </div>
          </div>

          <div class="section">
            <h2>üñºÔ∏è Î†àÌçºÎü∞Ïä§</h2>
            <div class="info-box">
              <p>ÏÑ†ÌÉùÎêú Î†àÌçºÎü∞Ïä§: ${(data.references || []).length}Í∞ú</p>
              <p>ÌÜ§Ïï§Îß§ÎÑà ÌÇ§ÏõåÎìú: ${(data.toneKeywords || []).join(', ') || 'ÎØ∏ÏßÄÏ†ï'}</p>
            </div>
          </div>

          <div class="section">
            <h2>üí∞ ÏÉÅÏÑ∏ Í≤¨Ï†Å</h2>
            <div class="price-highlight">
              ÏòàÏÉÅ Ï†úÏûëÎπÑÏö©: ${estimateData.mid?.toLocaleString() || '0'}Ïõê
            </div>
            <div class="info-box">
              <h3>Í≤¨Ï†Å Î≤îÏúÑ</h3>
              <div class="breakdown-item">
                <span>ÏµúÏÜå Í≤¨Ï†Å</span>
                <span>${estimateData.low?.toLocaleString() || '0'}Ïõê</span>
              </div>
              <div class="breakdown-item">
                <span>ÌëúÏ§Ä Í≤¨Ï†Å</span>
                <span>${estimateData.mid?.toLocaleString() || '0'}Ïõê</span>
              </div>
              <div class="breakdown-item">
                <span>ÏµúÎåÄ Í≤¨Ï†Å</span>
                <span>${estimateData.high?.toLocaleString() || '0'}Ïõê</span>
              </div>
            </div>
            <div class="info-box">
              <h3>ÎπÑÏö© ÏÑ∏Î∂Ä ÎÇ¥Ïó≠</h3>
              ${(estimateData.breakdown || []).map(item => 
                `<div class="breakdown-item">
                  <span>${item.name}</span>
                  <span>${item.impact?.toLocaleString() || '0'}Ïõê</span>
                </div>`
              ).join('')}
            </div>
          </div>

          <div class="section">
            <h2>üìÖ ÏòàÏÉÅ ÏùºÏ†ï</h2>
            <div class="info-box">
              <div class="price-highlight">
                Ï¥ù Ï†úÏûë Í∏∞Í∞Ñ: ${timelineData.total || 0}Ïùº
              </div>
              <h3>Îã®Í≥ÑÎ≥Ñ ÏùºÏ†ï</h3>
              ${(timelineData.phases || []).map(phase => 
                `<div class="timeline-item">
                  <span>${phase.name}</span>
                  <span>${phase.days}Ïùº</span>
                </div>`
              ).join('')}
            </div>
          </div>

          <div class="section">
            <h2>üìå ÌäπÏù¥ÏÇ¨Ìï≠ Î∞è Ï∂îÍ∞Ä ÏöîÏ≤≠</h2>
            <div class="info-box">
              <p><strong>1Îã®Í≥Ñ ÌäπÏù¥ÏÇ¨Ìï≠:</strong> ${data.step1Notes || 'ÏóÜÏùå'}</p>
              <p><strong>2Îã®Í≥Ñ ÌäπÏù¥ÏÇ¨Ìï≠:</strong> ${data.step2Notes || 'ÏóÜÏùå'}</p>
              <p><strong>3Îã®Í≥Ñ ÌäπÏù¥ÏÇ¨Ìï≠:</strong> ${data.step3Notes || 'ÏóÜÏùå'}</p>
              <p><strong>4Îã®Í≥Ñ ÌäπÏù¥ÏÇ¨Ìï≠:</strong> ${data.step4Notes || 'ÏóÜÏùå'}</p>
              <p><strong>5Îã®Í≥Ñ ÌäπÏù¥ÏÇ¨Ìï≠:</strong> ${data.step5Notes || 'ÏóÜÏùå'}</p>
              <p><strong>6Îã®Í≥Ñ ÌäπÏù¥ÏÇ¨Ìï≠:</strong> ${data.step6Notes || 'ÏóÜÏùå'}</p>
              <p><strong>7Îã®Í≥Ñ ÌäπÏù¥ÏÇ¨Ìï≠:</strong> ${additionalNotes || 'ÏóÜÏùå'}</p>
            </div>
          </div>

          <div class="section">
            <h2>üìä ÏãúÏû• Î∂ÑÏÑù Î∞è Ï∂îÏ≤úÏÇ¨Ìï≠</h2>
            <div class="info-grid">
              <div class="info-box">
                <h3>ÏãúÏû• Ìä∏Î†åÎìú</h3>
                <ul>
                  ${industryAnalysis.marketTrends.map(trend => `<li>${trend}</li>`).join('')}
                </ul>
              </div>
              <div class="info-box">
                <h3>ÏòàÏÇ∞ Í∞ÄÏù¥ÎìúÎùºÏù∏</h3>
                <ul>
                  ${industryAnalysis.budgetGuidelines.map(budget => `<li>${budget}</li>`).join('')}
                </ul>
              </div>
            </div>
            <div class="info-box">
              <h3>Ï†ÑÎ¨∏Í∞Ä Ï∂îÏ≤úÏÇ¨Ìï≠</h3>
              <ul>
                ${industryAnalysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
              </ul>
            </div>
          </div>

          <div class="section">
            <p style="text-align: center; color: #666; font-size: 12px; margin-top: 40px;">
              Î≥∏ Í≤¨Ï†ÅÏÑúÎäî Ï†úÏûë ÏùòÎ¢∞ Í≤¨Ï†Å ÏãúÏä§ÌÖúÏùÑ ÌÜµÌï¥ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.<br>
              Ï†ïÌôïÌïú Í≤¨Ï†ÅÏùÄ ÏÉÅÎã¥ÏùÑ ÌÜµÌï¥ ÌôïÏ†ïÎê©ÎãàÎã§.
            </p>
          </div>
        </body>
      </html>
    `;

    const printWindow = window.open('', '_blank');
    if (printWindow) {
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }
  };

  useEffect(() => {
    calculateDetailedEstimate();
  }, [calculateDetailedEstimate]);

  const getServiceInfo = () => {
    switch (serviceType) {
      case 'video':
        return {
          title: 'ÏòÅÏÉÅ Ï†úÏûë ÏµúÏ¢Ö Í≤¨Ï†Å',
          description: 'ÏÑ†ÌÉùÌïòÏã† ÏòµÏÖòÏùÑ Î∞îÌÉïÏúºÎ°ú ÏÇ∞Ï∂úÎêú ÏòÅÏÉÅ Ï†úÏûë Í≤¨Ï†ÅÏûÖÎãàÎã§.',
          color: 'blue'
        };
      case 'design':
        return {
          title: 'ÎîîÏûêÏù∏ Ï†úÏûë ÏµúÏ¢Ö Í≤¨Ï†Å',
          description: 'ÏÑ†ÌÉùÌïòÏã† ÏòµÏÖòÏùÑ Î∞îÌÉïÏúºÎ°ú ÏÇ∞Ï∂úÎêú ÎîîÏûêÏù∏ Ï†úÏûë Í≤¨Ï†ÅÏûÖÎãàÎã§.',
          color: 'green'
        };
      case 'marketing':
        return {
          title: 'ÎßàÏºÄÌåÖ ÏÑúÎπÑÏä§ ÏµúÏ¢Ö Í≤¨Ï†Å',
          description: 'ÏÑ†ÌÉùÌïòÏã† ÏòµÏÖòÏùÑ Î∞îÌÉïÏúºÎ°ú ÏÇ∞Ï∂úÎêú ÎßàÏºÄÌåÖ ÏÑúÎπÑÏä§ Í≤¨Ï†ÅÏûÖÎãàÎã§.',
          color: 'purple'
        };
      default:
        return {
          title: 'ÏµúÏ¢Ö Í≤¨Ï†Å',
          description: 'ÏÑ†ÌÉùÌïòÏã† ÏòµÏÖòÏùÑ Î∞îÌÉïÏúºÎ°ú ÏÇ∞Ï∂úÎêú Í≤¨Ï†ÅÏûÖÎãàÎã§.',
          color: 'blue'
        };
    }
  };

  const serviceInfo = getServiceInfo();

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-xl font-semibold mb-2">{serviceInfo.title}</h2>
        <p className="text-gray-600 mb-6">{serviceInfo.description}</p>
      </div>

      {/* ÌÉ≠ Î©îÎâ¥ */}
      <div className="flex space-x-1 bg-gray-100 p-1 rounded-lg">
        {[
          { id: 'estimate', name: 'üí∞ Í≤¨Ï†Å', icon: 'ri-money-dollar-circle-line' },
          { id: 'timeline', name: 'üìÖ ÏùºÏ†ï', icon: 'ri-calendar-line' },
          { id: 'analysis', name: 'üìä Î∂ÑÏÑù', icon: 'ri-bar-chart-line' }
        ].map((tab) => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id as any)}
            className={`flex-1 px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap cursor-pointer ${
              activeTab === tab.id
                ? `bg-${serviceInfo.color}-600 text-white`
                : 'text-gray-600 hover:text-gray-800'
            }`}
          >
            <i className={`${tab.icon} mr-2 w-4 h-4 flex items-center justify-center`}></i>
            {tab.name}
          </button>
        ))}
      </div>

      {/* Í≤¨Ï†Å ÌÉ≠ */}
      {activeTab === 'estimate' && (
        <div className="space-y-6">
          {/* Î©îÏù∏ Í≤¨Ï†Å */}
          <div className={`bg-gradient-to-r from-${serviceInfo.color}-50 to-indigo-50 border-2 border-${serviceInfo.color}-200 rounded-lg p-6`}>
            <h3 className={`font-semibold text-${serviceInfo.color}-800 mb-4 text-center`}>
              üéØ ÏµúÏ¢Ö Í≤¨Ï†Å Í≤∞Í≥º
            </h3>
            <div className="grid grid-cols-3 gap-4 mb-4">
              <div className="text-center">
                <div className={`text-lg font-bold text-${serviceInfo.color}-600`}>
                  {estimateData.low?.toLocaleString() || '0'}Ïõê
                </div>
                <div className={`text-sm text-${serviceInfo.color}-500`}>ÏµúÏÜå Í≤¨Ï†Å</div>
              </div>
              <div className="text-center">
                <div className={`text-3xl font-bold text-${serviceInfo.color}-600`}>
                  {estimateData.mid?.toLocaleString() || '0'}Ïõê
                </div>
                <div className={`text-sm text-${serviceInfo.color}-500`}>ÌëúÏ§Ä Í≤¨Ï†Å (Í∂åÏû•)</div>
              </div>
              <div className="text-center">
                <div className={`text-lg font-bold text-${serviceInfo.color}-600`}>
                  {estimateData.high?.toLocaleString() || '0'}Ïõê
                </div>
                <div className={`text-sm text-${serviceInfo.color}-500`}>ÏµúÎåÄ Í≤¨Ï†Å</div>
              </div>
            </div>
            <p className={`text-center text-sm text-${serviceInfo.color}-600`}>
              * ÏÑ†ÌÉùÌïòÏã† ÏÑ∏Î∂Ä ÏòµÏÖòÏùÑ Î™®Îëê Î∞òÏòÅÌïú Í≤¨Ï†ÅÏûÖÎãàÎã§
            </p>
          </div>

          {/* Í≤¨Ï†Å ÏÑ∏Î∂Ä ÎÇ¥Ïó≠ */}
          <div className="bg-white border border-gray-200 rounded-lg p-6">
            <h3 className="font-semibold text-gray-800 mb-4">üí∞ ÎπÑÏö© ÏÑ∏Î∂Ä ÎÇ¥Ïó≠</h3>
            <div className="space-y-3">
              {(estimateData.breakdown || []).map((item, index) => (
                <div key={index} className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-700">{item.name}</span>
                  <span className={`font-medium text-${serviceInfo.color}-600`}>
                    {item.impact?.toLocaleString() || '0'}Ïõê
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* ÏùºÏ†ï ÌÉ≠ */}
      {activeTab === 'timeline' && (
        <div className="space-y-6">
          <div className={`bg-gradient-to-r from-${serviceInfo.color}-50 to-indigo-50 border-2 border-${serviceInfo.color}-200 rounded-lg p-6`}>
            <h3 className={`font-semibold text-${serviceInfo.color}-800 mb-4 text-center`}>
              üìÖ ÏòàÏÉÅ Ï†úÏûë ÏùºÏ†ï
            </h3>
            <div className="text-center mb-4">
              <div className={`text-3xl font-bold text-${serviceInfo.color}-600`}>
                {timelineData.total || 0}Ïùº
              </div>
              <div className={`text-sm text-${serviceInfo.color}-500`}>Ï¥ù Ï†úÏûë Í∏∞Í∞Ñ</div>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-lg p-6">
            <h3 className="font-semibold text-gray-800 mb-4">üìã Îã®Í≥ÑÎ≥Ñ ÏùºÏ†ï</h3>
            <div className="space-y-3">
              {(timelineData.phases || []).map((phase, index) => (
                <div key={index} className="flex justify-between items-center py-3 border-b border-gray-100">
                  <div className="flex items-center">
                    <div className={`w-8 h-8 bg-${serviceInfo.color}-100 text-${serviceInfo.color}-600 rounded-full flex items-center justify-center text-sm font-bold mr-3`}>
                      {index + 1}
                    </div>
                    <span className="text-gray-700">{phase.name}</span>
                  </div>
                  <span className={`font-medium text-${serviceInfo.color}-600`}>
                    {phase.days}Ïùº
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* AI Î∂ÑÏÑù ÌÉ≠ */}
      {activeTab === 'analysis' && (
        <div className="space-y-6">
          <div className={`bg-gradient-to-r from-${serviceInfo.color}-50 to-indigo-50 border-2 border-${serviceInfo.color}-200 rounded-lg p-6`}>
            <h3 className={`font-semibold text-${serviceInfo.color}-800 mb-4 flex items-center`}>
              <i className="ri-ai-generate mr-2 w-5 h-5 flex items-center justify-center"></i>
              ü§ñ AI Í≤¨Ï†Å Î∂ÑÏÑù Î∞è Ï†úÏûëÏÇ¨ ÏÑ†ÌÉù Í∞ÄÏù¥Îìú
            </h3>
            <p className={`text-${serviceInfo.color}-700 text-sm`}>
              {serviceType === 'video' ? 'ÏòÅÏÉÅ Ï†úÏûë' : serviceType === 'design' ? 'ÎîîÏûêÏù∏ Ï†úÏûë' : 'ÎßàÏºÄÌåÖ ÏÑúÎπÑÏä§'} ÏóÖÍ≥Ñ Ìä∏Î†åÎìúÏôÄ ÏãúÏû• Î∂ÑÏÑùÏùÑ Î∞îÌÉïÏúºÎ°ú Ìïú Ï†ÑÎ¨∏Í∞Ä Ï°∞Ïñ∏ÏûÖÎãàÎã§.
            </p>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="bg-white border border-gray-200 rounded-lg p-6">
              <h4 className="font-semibold text-gray-800 mb-3">üìà ÏãúÏû• Ìä∏Î†åÎìú</h4>
              <ul className="space-y-2">
                {industryAnalysis.marketTrends.map((trend, index) => (
                  <li key={index} className="flex items-start text-sm text-gray-700">
                    <span className={`text-${serviceInfo.color}-500 mr-2`}>‚Ä¢</span>
                    {trend}
                  </li>
                ))}
              </ul>
            </div>

            <div className="bg-white border border-gray-200 rounded-lg p-6">
              <h4 className="font-semibold text-gray-800 mb-3">üí° ÏòàÏÇ∞ Í∞ÄÏù¥ÎìúÎùºÏù∏</h4>
              <ul className="space-y-2">
                {industryAnalysis.budgetGuidelines.map((budget, index) => (
                  <li key={index} className="flex items-start text-sm text-gray-700">
                    <span className={`text-${serviceInfo.color}-500 mr-2`}>‚Ä¢</span>
                    {budget}
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-lg p-6">
            <h4 className="font-semibold text-gray-800 mb-3">üéØ Ï†ÑÎ¨∏Í∞Ä Ï∂îÏ≤úÏÇ¨Ìï≠</h4>
            <ul className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {industryAnalysis.recommendations.map((rec, index) => (
                <li key={index} className="flex items-start text-sm text-gray-700">
                  <span className={`text-${serviceInfo.color}-500 mr-2`}>‚úì</span>
                  {rec}
                </li>
              ))}
            </ul>
          </div>
        </div>
      )}

      {/* Ï∂îÍ∞Ä ÌäπÏù¥ÏÇ¨Ìï≠ */}
      <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
        <h3 className="font-medium text-orange-800 mb-3">
          <i className="ri-edit-line mr-2 w-4 h-4 flex items-center justify-center"></i>
          ÏµúÏ¢Ö ÌäπÏù¥ÏÇ¨Ìï≠ Î∞è ÏöîÏ≤≠ÏÇ¨Ìï≠
        </h3>
        <textarea
          value={additionalNotes}
          onChange={(e) => setAdditionalNotes(e.target.value)}
          placeholder="Ïòà: ÏòàÏÇ∞ Ï°∞Ï†ï ÌïÑÏöîÏÑ±, ÏùºÏ†ï Îã®Ï∂ï/Ïó∞Ïû• ÏöîÏ≤≠, Ï∂îÍ∞Ä ÏÑúÎπÑÏä§ ÌïÑÏöî, Í≥ÑÏïΩ Ï°∞Í±¥ Îì±"
          className="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none bg-white"
          rows={4}
        />
      </div>

      {/* Ïï°ÏÖò Î≤ÑÌäºÎì§ */}
      <div className="bg-gray-50 rounded-lg p-6">
        <h3 className="font-semibold text-gray-800 mb-4">üìã Îã§Ïùå Îã®Í≥Ñ</h3>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <button
            onClick={handlePrintSummary}
            className={`px-6 py-3 bg-${serviceInfo.color}-600 text-white rounded-lg font-medium hover:bg-${serviceInfo.color}-700 transition-colors whitespace-nowrap cursor-pointer`}
          >
            <i className="ri-printer-line mr-2"></i>
            Í≤¨Ï†ÅÏÑú Ïù∏ÏáÑÌïòÍ∏∞
          </button>
          <button
            onClick={() => {
              const subject = encodeURIComponent(`${serviceType === 'video' ? 'ÏòÅÏÉÅ Ï†úÏûë' : serviceType === 'design' ? 'ÎîîÏûêÏù∏ Ï†úÏûë' : 'ÎßàÏºÄÌåÖ ÏÑúÎπÑÏä§'} Í≤¨Ï†Å Î¨∏Ïùò`);
              const body = encodeURIComponent(`Í≤¨Ï†Å Í∏àÏï°: ${estimateData.mid?.toLocaleString() || '0'}Ïõê\nÏ†úÏûë Í∏∞Í∞Ñ: ${timelineData.total || 0}Ïùº\n\nÏûêÏÑ∏Ìïú ÏÉÅÎã¥ÏùÑ ÏõêÌï©ÎãàÎã§.`);
              window.open(`mailto:?subject=${subject}&body=${body}`);
            }}
            className="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors whitespace-nowrap cursor-pointer"
          >
            <i className="ri-mail-line mr-2"></i>
            Ïù¥Î©îÏùº ÏÉÅÎã¥ÌïòÍ∏∞
          </button>
          <button
            onClick={onPrev}
            className="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors whitespace-nowrap cursor-pointer"
          >
            <i className="ri-arrow-left-line mr-2"></i>
            Ïù¥Ï†ÑÏúºÎ°ú Í∞ÄÍ∏∞
          </button>
          <button
            onClick={handleGoToFirst}
            className="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors whitespace-nowrap cursor-pointer"
          >
            <i className="ri-refresh-line mr-2"></i>
            Ï≤òÏùåÏúºÎ°ú Í∞ÄÍ∏∞
          </button>
        </div>
      </div>
    </div>
  );
}
